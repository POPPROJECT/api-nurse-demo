// à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸™à¸´à¸¢à¸¡
// migrate à¹€à¸à¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡ table Prisma à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸ªà¸£à¹‰à¸²à¸‡ table : npx prisma migrate dev --name init
// npx prisma db push
// à¸­à¸±à¸›à¹€à¸”à¸•à¸•à¸²à¸¡ schema à¸¥à¹ˆà¸²à¸ªà¸¸à¸” : npx prisma generate
// à¹€à¸Šà¹‡à¸„à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ : npx prisma studio

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int        @id @default(autoincrement())
  email     String     @unique
  name      String
  password  String? // âœ… optional à¸ªà¸³à¸«à¸£à¸±à¸š Google login
  avatarUrl String?
  role      Role       @default(STUDENT)
  provider  Provider   @default(LOCAL) // ğŸ‘ˆ enum à¹à¸¢à¸à¸›à¸£à¸°à¹€à¸ à¸— login
  status    UserStatus @default(ENABLE) // status user | enable à¸ˆà¸°à¸ªà¸²à¸¡à¸²à¸£à¸– login à¹„à¸”à¹‰à¸•à¸²à¸¡à¸›à¸à¸•à¸´ | disable à¸šà¸±à¸à¸Šà¸µà¸ˆà¸°à¸–à¸¹à¸à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸– login à¹„à¸”à¹‰
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  hashedRefreshToken String?

  studentProfile           StudentProfile?
  approverProfile          ApproverProfile?
  adminProfile             AdminProfile?
  experienceManagerProfile ExperienceManagerProfile?
  adminLogs                AdminLog[]
}

enum Role {
  STUDENT
  APPROVER_IN
  APPROVER_OUT
  ADMIN
  EXPERIENCE_MANAGER
}

enum UserStatus {
  ENABLE
  DISABLE
}

enum Provider {
  LOCAL
  GOOGLE
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROFILE
model StudentProfile {
  id          Int                 @id @default(autoincrement())
  userId      Int                 @unique
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentId   String?             @unique // âœ… à¸à¸£à¸­à¸à¸ à¸²à¸¢à¸«à¸¥à¸±à¸‡à¹„à¸”à¹‰
  experiences StudentExperience[]
}

model ApproverProfile {
  id     Int    @id @default(autoincrement())
  userId Int    @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  pin    String

  // à¸ˆà¸³à¸™à¸§à¸™à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¹ƒà¸ªà¹ˆ PIN à¸œà¸´à¸”à¸•à¸´à¸”à¸à¸±à¸™ (à¸£à¸µà¹€à¸‹à¹‡à¸•à¹€à¸¡à¸·à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¸«à¸£à¸·à¸­à¸à¹‰à¸™à¸Šà¹ˆà¸§à¸‡ cool-down)
  pinFailCount   Int       @default(0)
  // à¸–à¹‰à¸²à¹€à¸à¸´à¸™à¸ˆà¸³à¸™à¸§à¸™à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸à¸³à¸«à¸™à¸” à¸ˆà¸°à¸¥à¹‡à¸­à¸à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸™à¸à¸§à¹ˆà¸²à¸ˆà¸°à¸–à¸¶à¸‡à¹€à¸§à¸¥à¸²
  pinLockedUntil DateTime?
}

model AdminProfile {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ExperienceManagerProfile {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STUDENT EXPERIENCE
model StudentExperience {
  id           String           @id @default(uuid())
  bookId       Int // à¸ªà¸¡à¸¸à¸”à¸—à¸µà¹ˆà¸™à¸´à¸ªà¸´à¸•à¸à¸£à¸­à¸
  book         ExperienceBook   @relation(fields: [bookId], references: [id])
  course       String? // â† à¹€à¸à¹‡à¸šà¸Šà¸·à¹ˆà¸­ course
  subCourse    String? // â† à¹€à¸à¹‡à¸šà¸Šà¸·à¹ˆà¸­ subCourse
  subject      String? // â† à¹€à¸à¹‡à¸šà¸„à¹ˆà¸² à¹ƒà¸™à¸§à¸´à¸Šà¸²
  alwaycourse  Int? // â† à¹€à¸à¹‡à¸šà¸„à¹ˆà¸² à¸•à¸¥à¸­à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£
  fieldValues  FieldValue[] // à¸„à¹ˆà¸²à¸Ÿà¸´à¸¥à¸”à¹Œà¸—à¸µà¹ˆà¸™à¸´à¸ªà¸´à¸•à¸à¸£à¸­à¸
  approverRole Role
  approverName String
  status       ExperienceStatus @default(PENDING)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  studentId    Int
  student      StudentProfile   @relation(fields: [studentId], references: [id])
  isDeleted    Boolean          @default(false)

  @@index([studentId])
  @@index([bookId])
}

enum ExperienceStatus {
  PENDING
  CONFIRMED
  CANCEL
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPERIENCE BOOK
model ExperienceBook {
  id          Int                 @id @default(autoincrement())
  title       String // à¸Šà¸·à¹ˆà¸­à¸ªà¸¡à¸¸à¸” à¹€à¸Šà¹ˆà¸™ "Clinical Rotation Log"
  description String? // à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ (optional)
  fields      FieldConfig[] // à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œà¹„à¸›à¸¢à¸±à¸‡ config à¸‚à¸­à¸‡à¸Ÿà¸´à¸¥à¸”à¹Œ
  experiences StudentExperience[] // à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸à¸±à¸™à¸˜à¹Œà¹„à¸›à¸¢à¸±à¸‡ log à¸‚à¸­à¸‡à¸™à¸´à¸ªà¸´à¸•
  courses     Course[] //à¸„à¸­à¸£à¹Œà¸ª
  prefixes    BookPrefix[] // à¸­à¸™à¸¸à¸à¸²à¸•à¸£à¸«à¸±à¸ªà¸™à¸´à¸ªà¸´à¸•à¸›à¸µ
}

// FIELD STRUCTURE IN BOOK
model FieldConfig {
  id          Int            @id @default(autoincrement())
  bookId      Int // foreign key à¹„à¸›à¸¢à¸±à¸‡ ExperienceBook
  book        ExperienceBook @relation(fields: [bookId], references: [id], onDelete: Cascade)
  name        String // à¸„à¸µà¸¢à¹Œà¸ à¸²à¸¢à¹ƒà¸™ (unique à¸•à¹ˆà¸­à¹€à¸¥à¹ˆà¸¡) à¹€à¸Šà¹ˆà¸™ "location"
  label       String // à¸›à¹‰à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¹ƒà¸™ UI à¹€à¸Šà¹ˆà¸™ "à¸«à¸­à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢"
  type        FieldType // à¸Šà¸™à¸´à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  required    Boolean        @default(false) // à¸•à¹‰à¸­à¸‡à¸à¸£à¸­à¸à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
  order       Int // à¸¥à¸³à¸”à¸±à¸šà¸à¸²à¸£à¹à¸ªà¸”à¸‡
  options     String[] // à¸ªà¸³à¸«à¸£à¸±à¸š SELECT à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ (à¹€à¸Šà¹ˆà¸™ ["A","B","C"])
  fieldValues FieldValue[]

  @@unique([bookId, name])
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  TEXTAREA
}

// PERMITTED STUDENT ID
model BookPrefix {
  id        Int            @id @default(autoincrement())
  bookId    Int
  prefix    String // à¸£à¸«à¸±à¸ªà¸›à¸µà¸—à¸µà¹ˆà¸­à¸™à¸¸à¸à¸²à¸• à¹€à¸Šà¹ˆà¸™ "64" à¸«à¸£à¸·à¸­ "623"
  book      ExperienceBook @relation(fields: [bookId], references: [id], onDelete: Cascade)
  createdAt DateTime       @default(now())

  @@index([bookId])
}

// THE VALUE OF EACH FIELD THAT STUDENTS RECORDED
model FieldValue {
  id           Int               @id @default(autoincrement())
  experienceId String
  experience   StudentExperience @relation(fields: [experienceId], references: [id], onDelete: Cascade)
  fieldId      Int
  field        FieldConfig       @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  value        String // à¹€à¸à¹‡à¸šà¹€à¸›à¹‡à¸™ string à¸—à¸¸à¸à¸Šà¸™à¸´à¸” à¹à¸¥à¹‰à¸§à¹à¸›à¸¥à¸‡à¸•à¸²à¸¡ type à¹€à¸¡à¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¸œà¸¥

  @@index([experienceId])
  @@index([fieldId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COURSE
model Course {
  id         Int            @id @default(autoincrement())
  bookId     Int
  book       ExperienceBook @relation(fields: [bookId], references: [id], onDelete: Cascade)
  name       String
  subCourses SubCourse[]

  @@index([bookId])
}

model SubCourse {
  id          Int    @id @default(autoincrement())
  courseId    Int
  course      Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  name        String
  subject     String?
  alwaycourse Int?
}

model AdminLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String // 'create', 'update', 'delete'
  entity      String // 'User', 'ExperienceBook'
  entityId    Int?
  description String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entity])
}

model AdminSetting {
  id                          Int     @id @default(1)
  isExperienceCountingEnabled Boolean @default(true)
}
